# requests使用与源码分析

官方中文文档： https://requests.readthedocs.io/projects/cn/zh-cn/latest/user/quickstart.html#id2



## 常用参数与源码分析

我们统一使用requests的request来发包，这样可以提醒我们发包请求

### method

#### 作用

指定发包类型

```python
r = requests.request(
    method="get"
    url='http://httpbin.org/post',
)
```

#### 源码分析

我们看一下get源码

![1748397996201](assets/1748397996201.png)

这里实际上最后调用的都是request



### params

#### 作用

```python
resp = requests.request(
    method="get",
    url='http://httpbin.org/post',
    params={'key1': 'value1', 'key2': 'value2'}
)
print(resp.url)
```

![1748398125796](assets/1748398125796.png)

本质上就是按照

k=v得到一个参数，之后在进行&拼接

```python
dct = {"k1":1, "k2":"2"}
url_param = "&".join([f"{k}={v}" for k, v in dct])
url = 'http://httpbin.org/post'
url = url + "?" + url_param
url
```

![1748398325796](assets/1748398325796.png)



#### 源码分析

我们看一下request对象源码

![1748398369729](assets/1748398369729.png)

params被传入之后丢进kwargs字典中

![1748398575089](assets/1748398575089.png)

我们再看Request对象

![1748398671200](assets/1748398671200.png)

![1748398752627](assets/1748398752627.png)



我们回头看resp怎么拿到的

![1748398849051](assets/1748398849051.png)

这里request传入params之后封装成req对象，然后经过预处理得到prep，再丢给send方法拿到resp

![1748398946095](assets/1748398946095.png)

点进来，把对象传进来丢到了p对象的prepare方法中，我们点进这个方法

![1748399002561](assets/1748399002561.png)

进入prepare_url方法中

![1748399055690](assets/1748399055690.png)

点进去，代码有点多，我们复制到其他地方，顺便删一下注释，再折叠一下

![1748399250092](assets/1748399250092.png)

折叠进来之后，我们分析一下大体逻辑，主要就是把url进行处理，最后丢给self中

![1748399588658](assets/1748399588658.png)

![1748399876928](assets/1748399876928.png)

我们先看一下 `self._encode_params`

![1748400218871](assets/1748400218871.png)

然后urlencode一下



回退外层的 `urlunparse`和 `requote_url` 

![1748400440589](assets/1748400440589.png)

代码比较少我们看一下注释，这一步是拿到完整url字符串

最后返回给 `requote_url` 进行安全的urlencode编码

![1748399938068](assets/1748399938068.png)



外层函数是进行安全的urlencode



源码流程是：

- 拿到url，params
- 合法性校验：非空判断、类型判断
- 将params的进行编码后添加到url后面
  - url中可能存在了一些k=v，按照&添加
  - 如果url中没有就？填充





### data